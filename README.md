# Wizard of Music bot

Бот предназначен для соединения пар пользователей (покупатель и продавец), которые бы между собой торговались.

![image of Rincewind the Wizzard](https://cdn.drawception.com/images/panels/2016/4-27/htzf4P12rT-4.png)


## Принцип работы бота

Каждый юзер может находиться в нескольких состояниях (`current_state`):
- `active`    - не играет, но готов начинать игру прямо сейчас
- `inactive`  - не играет, и не готов начинать игру прямо сейчас
- `in_game` - играет с соответствующей ролью
- `feedback_(deal/why_not/terms/like)` - завершил игру, и отвечает на вопросы про неё

Кроме состояния, у игрока ещё может быть роль (`current_role`): `buyer` либо `seller` либо пустая. 
Роль обнуляется при переходе в состояния `active` и `inactive`, т.е. при завершении каждой игры.

Виды фидбека:
- `deal` - смогли ли договориться о сделке
- `terms` - на каких условиях договорились (только если смогли)
- `why_not` - почему не удалось договориться (только если не смогли)
- `like` - насколько понравилась игра, по шкале от 1 до 5

Возможные переходы:
 - `inactive --> in_game`: по кнопке "начать игру" (если есть с кем играть, т.е. есть кто-то в состоянии `active`). 
 Выбор между ролями `buyer` и `seller` совершается случайно.
 - `inactive --> active`: по кнопке "начать игру" (если не с кем играть)
 - `active --> in_game`: если другой игрок нажал "начать игру"
 - `active --> inactive`: по кнопке "не начинать игру"
 - `in_game --> feedback`: по кнопке "завершить игру" (в т.ч. если её нажмёт второй игрок)
- `feedback --> inactive`: после того, как ответит на все вопросы про завершившуюся игру

Кроме этого, у каждого состояния есть два бинарный модификатор `allow_notifications`,
он определяет, получает ли юзер, находясь в состоянии inactive, уведомления
о других игроках, переходящих в состояние active. Он переключается отдельной кнопкой 
"получать уведомления" / "не получать уведомления". 

Все сообщения логируются в mongodb. В отдельную табличку логируются все события, непосредственно относящиеся к игре
(сообщения внутри игры, а также начало и конец игры и фидбеки). 


## Как запустить бота в тестовом режиме

1) Получить создать в боте @botfather нового бота и получить для него токен 
2) Клонировать себе этот репозиторий
3) Запустить в командную строку примерно следующее:
```commandline
cd {папка с ботом}
export TOKEN={полученный вами от @botfather токен}
pip install pytelegrambotapi
python main.py --poll
```
Примечания:
   1) Если вы в windows, вместо `export` пишите `set`. 
   2) Если вы получаете ошибку подключения к серверу telegram, включите VPN и попробуйте еще раз
   3) Если ваш питон по умолчанию - второй, пишите `pip3` и `python3`
   4) Если у вас нет питона или пипа, пожалуйста, найдите способ это исправить самостоятельно
